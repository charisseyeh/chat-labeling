<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Labeler</title>
    <!-- CSS Files -->
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/buttons.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/conversation.css">
    <link rel="stylesheet" href="styles/messages.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/dark-mode.css">
</head>
<body>
    <script src="js/header.js"></script>
    <script>
        // Initialize header for labeler page
        document.addEventListener('DOMContentLoaded', function() {
            initializeHeader({
                title: '<span id="headerTitle">Conversation Labeler</span>',
                stats: '<span id="headerMeta"></span>',
                navigation: `
                    <div class="action-with-dropdown">
                      <button id="saveCompareBtn" class="btn btn--accent" onclick="saveAndCompareWithAI()">Save and compare with AI</button>
                      <button id="saveCompareMenuBtn" class="btn btn--outline chevron-btn" aria-label="More options" aria-haspopup="true" aria-expanded="false" aria-controls="saveCompareMenu" onclick="toggleSaveCompareMenu()">
                        <svg class="icon icon-chevron-down" viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="16" height="16">
                          <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </button>
                      <div id="saveCompareMenu" class="dropdown-menu" role="menu" aria-hidden="true">
                        <div class="dropdown-item">
                          <label for="modelSelect">AI label with</label>
                          <select id="modelSelect" onchange="onModelChange(event)">
                            <optgroup label="GPT-5 Models">
                              <option value="gpt-5">gpt-5 (Latest)</option>
                              <option value="gpt-5-2024-10-01">gpt-5-2024-10-01</option>
                            </optgroup>
                            <optgroup label="GPT-4o Models">
                              <option value="gpt-4o">gpt-4o (Latest)</option>
                              <option value="gpt-4o-2024-07-01">gpt-4o-2024-07-01</option>
                              <option value="gpt-4o-mini">gpt-4o-mini</option>
                              <option value="gpt-4o-mini-2024-07-01">gpt-4o-mini-2024-07-01</option>
                            </optgroup>
                            <optgroup label="GPT-4 Turbo Models">
                              <option value="gpt-4-turbo">gpt-4-turbo</option>
                              <option value="gpt-4-turbo-2024-04-09">gpt-4-turbo-2024-04-09</option>
                              <option value="gpt-4-turbo-preview">gpt-4-turbo-preview</option>
                            </optgroup>
                            <optgroup label="GPT-3.5 Turbo Models">
                              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                              <option value="gpt-3.5-turbo-0125">gpt-3.5-turbo-0125</option>
                              <option value="gpt-3.5-turbo-1106">gpt-3.5-turbo-1106</option>
                              <option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>
                            </optgroup>
                            <optgroup label="GPT-4 Models">
                              <option value="gpt-4">gpt-4</option>
                              <option value="gpt-4-0613">gpt-4-0613</option>
                              <option value="gpt-4-32k">gpt-4-32k</option>
                              <option value="gpt-4-32k-0613">gpt-4-32k-0613</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="dropdown-item">
                          <label for="apiKeyInput">OpenAI API Key</label>
                          <div class="input-row">
                            <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API key" />
                            <button class="btn btn--outline" onclick="saveApiKeyFromInput()">Save</button>
                            <button class="btn" onclick="clearApiKeyFromUI()">Clear</button>
                          </div>
                          <div id="apiKeyStatus" class="api-key-status">Loading API key...</div>
                        </div>
                        <button class="dropdown-link" onclick="togglePromptSidebar()">View system prompt</button>
                        <button class="dropdown-link" onclick="toggleSurveyConfigSidebar()">Customize survey labels</button>
                      </div>
                    </div>
                `
            });
            
            // Initialize API key status after header is set up
            setTimeout(() => {
                if (window.getStoredApiKey) {
                    loadApiKeyStatus();
                }
            }, 100);
        });
    </script>

    <div class="conversation-container">
        <div id="conversationDisplay">
            <!-- Conversations will be loaded here -->
        </div>

    </div>

    <!-- Bottom navigation (sticky) -->
    <div class="header header--bottom">
        <div class="header-content">
            <div class="header-left">
                <div class="stats">Conversation <span id="bottomCurrentConversation">0</span> of <span id="bottomTotalConversations">0</span></div>
            </div>
            <div class="header-navigation">
                <button class="btn btn--outline" onclick="previousConversation()">← Previous</button>
                <button class="btn btn--accent" onclick="nextConversation()">Next →</button>
            </div>
        </div>
    </div>

    <!-- External dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Right sidebar for system prompt -->
    <aside id="promptSidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-header">
        <h3>System prompt</h3>
        <button class="btn btn--outline" onclick="togglePromptSidebar()">Close</button>
      </div>
      <div class="sidebar-content">
        <label for="systemMessageInput">System message</label>
        <textarea id="systemMessageInput" rows="4"></textarea>
        <label for="promptTemplateInput" style="margin-top:12px;">Prompt template (prepended to conversation)</label>
        <textarea id="promptTemplateInput" rows="16"></textarea>
      </div>
      <div class="sidebar-footer">
        <button class="btn btn--accent" onclick="savePromptSettings()">Save</button>
      </div>
    </aside>

    <!-- Survey configuration sidebar -->
    <aside id="surveyConfigSidebar" class="sidebar" aria-hidden="true">
      <div class="sidebar-header">
        <h3>Customize Survey Labels</h3>
        <button class="btn btn--outline" onclick="toggleSurveyConfigSidebar()">Close</button>
      </div>
      <div class="sidebar-content">
        <div class="survey-config-controls">
          <button class="btn btn--outline" onclick="addNewQuestion()">Add New Question</button>
          <button class="btn btn--outline" onclick="resetToDefault()">Reset to Default</button>
        </div>
        <div id="surveyQuestionsContainer">
          <!-- Survey questions will be rendered here -->
        </div>
      </div>
      <div class="sidebar-footer">
        <button class="btn btn--accent" onclick="saveSurveyConfig()">Save Changes</button>
        <button class="btn btn--outline" onclick="previewAiPrompt()">Preview AI Prompt</button>
      </div>
    </aside>

    <!-- JavaScript Files -->
    <script src="js/dark-mode.js"></script>
    <script src="js/ai-labeling.js"></script>
    <script src="js/comparisons.js"></script>
    <script type="module" src="js/conversation-core.js"></script>

    <script>
      // Dropdown logic
      function toggleSaveCompareMenu() {
        const btn = document.getElementById('saveCompareMenuBtn');
        const menu = document.getElementById('saveCompareMenu');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        menu.setAttribute('aria-hidden', String(expanded));
        menu.classList.toggle('is-open', !expanded);
        if (!expanded) {
          // Sync current model selection
          const select = document.getElementById('modelSelect');
          if (window.getAiModel) {
            select.value = window.getAiModel();
          }
          // Load API key status when opening the menu
          loadApiKeyStatus();
        }
      }

      function onModelChange(e) {
        if (window.setAiModel) {
          window.setAiModel(e.target.value);
          console.log('[AI Labeling][UI] Model changed to:', e.target.value);
        }
      }

      // Sidebar logic
      function togglePromptSidebar() {
        const el = document.getElementById('promptSidebar');
        const isHidden = el.getAttribute('aria-hidden') === 'true';
        el.setAttribute('aria-hidden', String(!isHidden));
        el.classList.toggle('is-open', isHidden);
        if (isHidden) {
          // Populate inputs from current settings
          const sys = window.getSystemMessage ? window.getSystemMessage() : '';
          const tmpl = window.getPromptTemplate ? window.getPromptTemplate() : '';
          document.getElementById('systemMessageInput').value = sys;
          document.getElementById('promptTemplateInput').value = tmpl;
        }
      }

      function savePromptSettings() {
        const sys = document.getElementById('systemMessageInput').value;
        const tmpl = document.getElementById('promptTemplateInput').value;
        if (window.setSystemMessage) window.setSystemMessage(sys);
        if (window.setPromptTemplate) window.setPromptTemplate(tmpl);
        console.log('[AI Labeling][UI] System message saved (len):', sys.length);
        console.log('[AI Labeling][UI] Prompt template saved (len):', tmpl.length);
        togglePromptSidebar();
      }

      // API Key management functions
      function saveApiKeyFromInput() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        if (apiKey) {
          if (window.setStoredApiKey) {
            window.setStoredApiKey(apiKey);
            updateApiKeyStatus('API key saved successfully!', 'success');
            console.log('[AI Labeling][UI] API key saved');
          }
        } else {
          updateApiKeyStatus('Please enter your OpenAI API key', 'error');
        }
      }

      function clearApiKeyFromUI() {
        if (window.clearStoredApiKey) {
          window.clearStoredApiKey();
          document.getElementById('apiKeyInput').value = '';
          updateApiKeyStatus('API key cleared. Please enter a new key to use AI features.', 'info');
          console.log('[AI Labeling][UI] API key cleared');
        }
      }

      function updateApiKeyStatus(message, type) {
        const statusEl = document.getElementById('apiKeyStatus');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.className = `api-key-status ${type}`;
          setTimeout(() => {
            if (!window.getStoredApiKey || !window.getStoredApiKey()) {
              statusEl.textContent = 'No API key found. Please enter your OpenAI API key above.';
              statusEl.className = 'api-key-status error';
            } else {
              statusEl.textContent = 'API key loaded';
              statusEl.className = 'api-key-status success';
            }
          }, 3000);
        }
      }

      function loadApiKeyStatus() {
        const statusEl = document.getElementById('apiKeyStatus');
        if (window.getStoredApiKey) {
          const storedKey = window.getStoredApiKey();
          if (storedKey) {
            statusEl.textContent = 'API key loaded';
            statusEl.className = 'api-key-status success';
            // Mask the API key in the input field
            const maskedKey = window.maskApiKey ? window.maskApiKey(storedKey) : '••••••••••••••••';
            document.getElementById('apiKeyInput').value = maskedKey;
          } else {
            statusEl.textContent = 'No API key found. Please enter your OpenAI API key above.';
            statusEl.className = 'api-key-status error';
          }
        }
      }

      // Survey configuration sidebar logic
      function toggleSurveyConfigSidebar() {
        const el = document.getElementById('surveyConfigSidebar');
        const isHidden = el.getAttribute('aria-hidden') === 'true';
        el.setAttribute('aria-hidden', String(!isHidden));
        el.classList.toggle('is-open', isHidden);
        if (isHidden) {
          // Load current survey configuration
          loadSurveyConfig();
        }
      }

      function loadSurveyConfig() {
        try {
          // Import the SurveyConfigManager dynamically
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            renderSurveyQuestions(configManager);
          }).catch(error => {
            console.error('Failed to load survey config module:', error);
            document.getElementById('surveyQuestionsContainer').innerHTML = '<p>Error loading survey configuration</p>';
          });
        } catch (error) {
          console.error('Error in loadSurveyConfig:', error);
        }
      }

      function renderSurveyQuestions(configManager) {
        const container = document.getElementById('surveyQuestionsContainer');
        const questions = configManager.getQuestions();
        
        let html = '';
        questions.forEach((question, index) => {
          html += `
            <div class="survey-question-editor" data-question-id="${question.id}">
              <div class="question-header">
                <h4>Question ${index + 1}</h4>
                <button class="btn btn--small btn--outline" onclick="removeQuestion('${question.id}')">Remove</button>
              </div>
              <div class="question-fields">
                <label>Title:</label>
                <input type="text" class="question-title" value="${question.title}" onchange="updateQuestionField('${question.id}', 'title', this.value)">
                
                <label>Description:</label>
                <textarea class="question-description" rows="2" onchange="updateQuestionField('${question.id}', 'description', this.value)">${question.description}</textarea>
                
                <label>Options (1-7 scale):</label>
                <div class="question-options">
                  ${question.options.map((option, optIndex) => `
                    <div class="option-row">
                      <span class="option-number">${optIndex + 1}:</span>
                      <input type="text" class="option-text" value="${option}" onchange="updateQuestionOption('${question.id}', ${optIndex}, this.value)">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      }

      function updateQuestionField(questionId, field, value) {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            const updates = { [field]: value };
            configManager.updateQuestion(questionId, updates);
          });
        } catch (error) {
          console.error('Error updating question field:', error);
        }
      }

      function updateQuestionOption(questionId, optionIndex, value) {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            const question = configManager.getQuestionById(questionId);
            if (question) {
              const newOptions = [...question.options];
              newOptions[optionIndex] = value;
              configManager.updateQuestion(questionId, { options: newOptions });
            }
          });
        } catch (error) {
          console.error('Error updating question option:', error);
        }
      }

      function addNewQuestion() {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            const newQuestion = {
              id: 'custom_' + Date.now(),
              title: 'New Question',
              description: 'Describe what this question measures',
              options: [
                'Not at all true',
                'Mostly not true',
                'Somewhat not true',
                'Neutral',
                'Somewhat true',
                'Mostly true',
                'Completely true'
              ]
            };
            
            if (configManager.addQuestion(newQuestion)) {
              renderSurveyQuestions(configManager);
            }
          });
        } catch (error) {
          console.error('Error adding new question:', error);
        }
      }

      function removeQuestion(questionId) {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            if (configManager.removeQuestion(questionId)) {
              renderSurveyQuestions(configManager);
            }
          });
        } catch (error) {
          console.error('Error removing question:', error);
        }
      }

      function resetToDefault() {
        if (confirm('Are you sure you want to reset to the default survey questions? This will remove all custom questions.')) {
          try {
            import('./js/survey-config.js').then(module => {
              const configManager = new module.SurveyConfigManager();
              configManager.resetToDefault();
              renderSurveyQuestions(configManager);
            });
          } catch (error) {
            console.error('Error resetting to default:', error);
          }
        }
      }

      function saveSurveyConfig() {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            configManager.saveConfig();
            alert('Survey configuration saved successfully!');
          });
        } catch (error) {
          console.error('Error saving survey config:', error);
          alert('Error saving survey configuration');
        }
      }

      function previewAiPrompt() {
        try {
          import('./js/survey-config.js').then(module => {
            const configManager = new module.SurveyConfigManager();
            const prompt = configManager.generateAiPromptTemplate();
            
            // Show prompt in a modal or alert
            const promptWindow = window.open('', '_blank', 'width=800,height=600');
            promptWindow.document.write(`
              <html>
                <head><title>AI Prompt Preview</title></head>
                <body style="font-family: monospace; white-space: pre-wrap; padding: 20px;">
                  <h2>AI Prompt Template</h2>
                  <p>This is the prompt that will be sent to the AI based on your current survey configuration:</p>
                  <hr>
                  ${prompt}
                </body>
              </html>
            `);
          });
        } catch (error) {
          console.error('Error previewing AI prompt:', error);
        }
      }

      // Close menu on outside click
      document.addEventListener('click', (e) => {
        const menu = document.getElementById('saveCompareMenu');
        const toggleBtn = document.getElementById('saveCompareMenuBtn');
        if (!menu || !toggleBtn) return;
        const clickedInside = menu.contains(e.target) || toggleBtn.contains(e.target);
        if (!clickedInside && menu.classList.contains('is-open')) {
          toggleSaveCompareMenu();
        }
      });
    </script>
</body>
</html> 